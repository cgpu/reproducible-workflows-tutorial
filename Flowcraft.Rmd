---
title: "Session 1: Flowcraft"
output: 
  html_document:
    toc: true
    toc_float: true  
    code_folding: show
    code_download: false
    theme: cerulean  
    highlight: kate         
---



![](images/flowcraft_exclamation_mark.gif)

What is FlowCraft? Why use it? 
[See FlowCraft slides](https://slides.com/diogosilva-1/nextflow-workshop-2018-6#/)

**Main outcome:** *During this session, you will learn how to build your own Fastqc FlowCraft component & GATK pipeline*

# a) Installation

FlowCraft is available to install via both Conda & Pip. However, as we are going to building components we want to install the development version. This can be done with the following commands:
```bash
git clone https://github.com/assemblerflow/flowcraft.git
cd flowcraft
python3 setup.py install
```

# b) How to build a FlowCraft Component
FlowCraft allows you to build pipelines from components. In order to create a new Component, two files are required. These are the template & the class.

## i. Templates
Inside of the `flowcraft` directory, create & open a new [file](https://github.com/assemblerflow/flowcraft/commit/7a4575bc0fab7c54d7f427805dff5b47ef0a666b) `flowcraft/generator/templates/fastqc2.nf` in your favourite code editor:
```nextflow
process fastqc2_{{ pid }} {

    {% include "post.txt" ignore missing %}

    tag { sample_id }
    publishDir "results/fastqc2_{{ pid }}", mode: 'copy'

    input:
    set sample_id, file(fastq_pair) from {{ input_channel }}

    output:
    file "*_fastqc.{zip,html}" into {{ output_channel }}
    {% with task_name="fastqc2" %}
    {%- include "compiler_channels.txt" ignore missing -%}
    {% endwith %}

    script:
    """
    fastqc $fastq_pair
    """
}

{{ forks }}
```

This is standard Nextflow code which is used as a template. Any code in the double curley brackets `{{}}` is FlowCraft code which will be replaced when building pipelines.

## ii. Classes

Inside of the `flowcraft` directory, open & add the following [changes](https://github.com/assemblerflow/flowcraft/commit/43d9ffdb7b1ca5c9e65a4444356cdc7c6bdae404) to the file `flowcraft/generator/components/reads_quality_control.py` in your favourite code editor:

```python
class Fastqc2(Process):
    def __init__(self, **kwargs):
        super().__init__(**kwargs)

        self.input_type = "fastq"
        self.output_type = "fastq"

        self.directives = {"fastqc2": {
            "cpus": 2,
            "memory": "'4GB'",
            "container": "flowcraft/fastqc",
            "version": "0.11.7-1"
        }}

        self.status_channels = [
            "fastqc2"
        ]
```

Here we set the following:
- the **inputs & outputs** which allows processes to be connected
- the **parameters** required by the process (none in this case)
- the **directives** for the process, including the docker container we want to use. Here the `version` is the `tag` of the docker container
- the **status channels** for the process to log its status

# c) Building a pipeline with FlowCraft

Now if we add the directory containing `flowcraft.py` to our path, we can then build a pipeline from any directory, eg:
```bash
export PATH=$PATH:/path/to/flowcraft/flowcraft
```

Now we can test the component we have built with the command:
```bash
flowcraft.py build -t "fastqc2" -o fastqc.nf
```

This will create a Nextflow script `fastqc.nf`    

More complex pipelines such as a GATK pipeline can be built with one command:
```bash
flowcraft.py build -t "bwa mark_duplicates haplotypecaller" -o main.nf --merge-params
```

Here the `merge-params` flag is used to merges all parameters with the same name in a single parameter


# Next up: [Session 4:  Running Nextflow Pipelines on The Cloud on Deploit](Deploit.html)

<br />